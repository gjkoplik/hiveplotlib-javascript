# Contributing

## Prerequisites

- Node.js 18+
- npm

## Setup

```bash
npm install
```

## Development Workflow

### Code Quality

This project uses **ESLint** for linting and **Prettier** for formatting. A pre-commit
hook (via husky + lint-staged) automatically runs both on staged files, so most issues
are caught before they reach CI.

```bash
# lint
npm run lint

# auto-format everything
npm run format

# check formatting without writing (used in CI)
npm run format:check
```

If you use VS Code, the repo includes recommended extensions (`esbenp.prettier-vscode`
and `dbaeumer.vscode-eslint`) and workspace settings that enable format-on-save. VS Code
should prompt you to install them when you first open the project.

### 1. Run the test suite

```bash
# single run
npm test

# watch mode (re-runs on file changes)
npm run test:watch
```

### 2. Visual sanity check

Serve the repo with any static file server and open `index.html` in a browser:

```bash
npx serve .
# then open http://localhost:3000/index.html
```

`index.html` renders every test fixture and the example hive plot using the source
`hive_plots_d3_viz.js` (not the minified bundle), so you can edit the source, refresh
the page, and see changes immediately.

### 3. Rebuild the minified bundle

```bash
npm run build
```

This produces `hive_plots_d3_viz.min.js`, the ESM bundle consumed by end users via CDN.
The D3 CDN import is preserved as an external dependency.

## Project Structure

```
hive_plots_d3_viz.js          # single source file (all rendering functions)
hive_plots_d3_viz.min.js      # minified ESM bundle (committed, rebuilt via npm run build)
example_hive_plot.json         # example data used in docs and index.html
index.html                     # local dev page for visual testing
vitest.config.js               # test config (jsdom env, CDNâ†’npm d3 alias)
tests/
  hive_plots_d3_viz.test.js    # vitest test suite
  fixtures/                    # JSON fixtures generated by hiveplotlib (Python)
    minimal_hive_plot.json
    multi_tag_hive_plot.json
    full_kwargs_hive_plot.json
.github/workflows/ci.yml       # GitHub Actions CI (Node 18/20/22)
.github/dependabot.yml         # Dependabot config (npm + actions)
eslint.config.js               # ESLint flat config
.prettierrc                    # Prettier config
.prettierignore                # files Prettier should skip
.husky/pre-commit              # pre-commit hook (runs lint-staged)
.vscode/                       # VS Code workspace settings + recommended extensions
```

## Test Fixtures

The JSON files under `tests/fixtures/` and `example_hive_plot.json` are **generated by
Python** from the `hiveplotlib` repository, not hand-crafted. Each fixture has a
corresponding static method in `hiveplotlib.datasets`:

| Fixture                      | Static Method                     |
| ---------------------------- | --------------------------------- |
| `example_hive_plot.json`     | `example_hive_plot()`             |
| `minimal_hive_plot.json`     | `example_minimal_hive_plot()`     |
| `multi_tag_hive_plot.json`   | `example_multi_tag_hive_plot()`   |
| `full_kwargs_hive_plot.json` | `example_full_kwargs_hive_plot()` |

The `hiveplotlib` test suite verifies that each hive plot's `to_json()` output matches
its on-disk fixture. If you need to regenerate a fixture (e.g. after changing
`to_json()`), run the corresponding snippet from the Python repo root:

```python
from hiveplotlib.datasets import example_minimal_hive_plot

hp = example_minimal_hive_plot()
with open("./data/minimal_hive_plot.json", "w") as f:
    f.write(hp.to_json())
```

Then copy the updated file into this repo's `tests/fixtures/` directory.

## D3 Import Strategy

The source file imports D3 from a CDN:

```javascript
import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
```

This keeps the source directly usable in browsers and Jupyter notebooks without a
build step. For testing, `vitest.config.js` aliases the CDN URL to the npm `d3`
package so tests run against a local copy. The `npm run build` step marks the CDN
URL as external so the minified bundle also preserves this import.

## CI

GitHub Actions runs on push/PR to `main` across Node 18, 20, and 22. The CI job runs
linting, format checking, tests (with coverage), `npm audit`, and the production build.
Dependabot is configured to open weekly PRs for npm and GitHub Actions dependency updates.
